<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Parent – Smart Student Life (Local + AI)</title>
<style>
:root{--bg:#f7fafc;--panel:#fff;--soft:#f1f5f9;--border:#e5e7eb;--ink:#0f172a;--acc:#2563eb;--r:16px;--shadow:0 14px 36px rgba(2,6,23,.07)}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
.container{max-width:900px;margin:auto;padding:16px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--soft);cursor:pointer;font-weight:800}
.btn.acc{background:var(--acc);border-color:var(--acc);color:#fff}
input,textarea{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
textarea.share{width:100%;min-height:120px}
.note{color:#64748b;font-size:13px}
.chatlog{background:#0f172a;color:#e5e7eb;border-radius:14px;padding:12px;min-height:200px}
.chatlog .m{margin:6px 0;line-height:1.6}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h3>إعدادات</h3>
    <div class="row">
      <input id="openaiKey" style="min-width:480px" placeholder="OpenAI API Key"/>
      <button class="btn acc" id="saveKey">حفظ</button>
      <span class="note">يُخزّن محليًا.</span>
    </div>
  </div>

  <div class="card">
    <h3>لصق كود مشاركة الطالب</h3>
    <textarea id="shareIn" class="share" placeholder="ألصق كود المشاركة من الطالب…"></textarea>
    <div class="row"><button class="btn acc" id="load">تحميل البيانات</button></div>
    <div id="out" class="note"></div>
  </div>

  <div class="card">
    <h3>AI Report (تقرير شامل لوليّ الأمر)</h3>
    <div class="row"><button class="btn" id="aiReport">توليد تقرير شامل</button></div>
    <div id="report" class="chatlog"></div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
$('#openaiKey').value=localStorage.getItem('pa:key')||''; $('#saveKey').onclick=()=>{ localStorage.setItem('pa:key',$('#openaiKey').value.trim()); alert('تم الحفظ ✅'); };
function expand(txt){ try{ return JSON.parse(decodeURIComponent(escape(atob(txt.trim())))); }catch{ return null; } }
let data=null;
$('#load').onclick=()=>{ const d=expand($('#shareIn').value||''); if(!d){ $('#out').textContent='⚠️ كود غير صالح.'; data=null; return; }
  data=d; $('#out').textContent=`Loaded: الطالب ${d.studentId}, التاريخ ${d.date}, منجز/إجمالي: ${d.completedGoals}/${d.totalGoals}, خطوات ${d.steps}, ماء ${d.water}, نقاط ${d.points}.`; };
function push(where, text){ const div=document.createElement('div'); div.className='m'; div.textContent=text; where.appendChild(div); }
async function callAI(prompt){
  const key=(localStorage.getItem('pa:key')||'').trim(); if(!key){ push($('#report'),'⚠️ أدخل API Key أولًا'); return ''; }
  const body={model:"gpt-4o-mini",messages:[{role:"system",content:"You are an Arabic assistant writing comprehensive, empathetic parent reports from student daily summary."},{role:"user",content:prompt}],temperature:0.6};
  const r=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+key},body:JSON.stringify(body)}); const j=await r.json(); return j?.choices?.[0]?.message?.content?.trim()||"";
}
$('#aiReport').onclick=async()=>{
  if(!data){ push($('#report'),'⚠️ حمّل بيانات الطالب أولًا'); return; }
  $('#report').innerHTML='';
  const prompt=`اكتب تقريرًا شاملًا لوليّ الأمر عن أداء ابنه اليوم:
- رقم الطالب: ${data.studentId}
- التاريخ: ${data.date}
- الأهداف المنجزة/الإجمالي: ${data.completedGoals}/${data.totalGoals}
- الأهداف المتبقية: ${data.goalsPending.join(' | ') || 'لا شيء'}
- الخطوات: ${data.steps} (هدف 11000)
- الماء: ${data.water} مل (هدف 2000)
- BMI: ${data.bmi}
- النقاط: ${data.points}

ارسم صورة واضحة عن الالتزام، نقاط القوة، فرص التحسين، ثم أعطِ 6 توصيات عملية للأسبوع القادم (دراسة وصحة). اجعل النبرة مشجعة ومختصرة.`;
  push($('#report'),'إنشاء التقرير…');
  try{ const res=await callAI(prompt); if(res){ $('#report').innerHTML=''; push($('#report'),res); } }catch(e){ push($('#report'),'خطأ: '+e.message); }
};
</script>
</body></html>
